<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube ã‚³ãƒ¡ãƒ³ãƒˆåˆ†æ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .loading {
            display: none;
        }
        .result-section {
            margin-top: 30px;
        }
        .ranking-card {
            margin-bottom: 20px;
        }
        .sentiment-positive {
            color: #28a745;
            font-weight: bold;
        }
        .sentiment-negative {
            color: #dc3545;
            font-weight: bold;
        }
        .sentiment-neutral {
            color: #6c757d;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-5">YouTube ã‚³ãƒ¡ãƒ³ãƒˆåˆ†æ</h1>
        
        <!-- æœ€çµ‚æ›´æ–°æ—¥æ™‚è¡¨ç¤º -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>ãƒ‡ãƒ¼ã‚¿æœ€çµ‚æ›´æ–°æ—¥æ™‚</h3>
            </div>
            <div class="card-body">
                <div id="lastUpdated" class="text-center">
                    <span class="badge bg-info fs-6">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•æ™‚ã«è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™</span>
                </div>
            </div>
        </div>
                
                <div id="analysisResult" class="result-section" style="display: none;">
                    <h4>åˆ†æçµæœ</h4>
                    <div id="videoInfo"></div>
                    <div id="sentimentChart" style="width: 400px; height: 400px; margin: 20px auto;">
                        <canvas id="sentimentPieChart"></canvas>
                    </div>
                    
                    <!-- ä»£è¡¨ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div id="representativeComments" style="margin-top: 30px;">
                        <h5>ä»£è¡¨ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã„ã„ã­æ•°é †ï¼‰</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <h6>ãƒã‚¸ãƒ†ã‚£ãƒ–ã‚³ãƒ¡ãƒ³ãƒˆ ãƒˆãƒƒãƒ—5</h6>
                                    </div>
                                    <div class="card-body" id="positiveComments"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header bg-danger text-white">
                                        <h6>ãƒã‚¬ãƒ†ã‚£ãƒ–ã‚³ãƒ¡ãƒ³ãƒˆ ãƒˆãƒƒãƒ—5</h6>
                                    </div>
                                    <div class="card-body" id="negativeComments"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header bg-secondary text-white">
                                        <h6>ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆ ãƒˆãƒƒãƒ—5</h6>
                                    </div>
                                    <div class="card-body" id="neutralComments"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
            </div>
            <div class="card-body">
                <div id="rankingsResult" style="display: none;">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card ranking-card">
                                <div class="card-header bg-danger text-white">
                                    <h5>ãƒã‚¬ãƒ†ã‚£ãƒ–ã‚³ãƒ¡ãƒ³ãƒˆ ãƒˆãƒƒãƒ—10</h5>
                                </div>
                                <div class="card-body">
                                    <div id="negativeRanking"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card ranking-card">
                                <div class="card-header bg-success text-white">
                                    <h5>ãƒã‚¸ãƒ†ã‚£ãƒ–ã‚³ãƒ¡ãƒ³ãƒˆ ãƒˆãƒƒãƒ—10</h5>
                                </div>
                                <div class="card-body">
                                    <div id="positiveRanking"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card ranking-card">
                                <div class="card-header bg-primary text-white">
                                    <h5>ã‚³ãƒ¡ãƒ³ãƒˆæ•° ãƒˆãƒƒãƒ—20</h5>
                                </div>
                                <div class="card-body">
                                    <div id="commentsRanking"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æœˆåˆ¥ã‚³ãƒ¡ãƒ³ãƒˆæ•°æ¨ç§»ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>æœˆåˆ¥ã‚³ãƒ¡ãƒ³ãƒˆæ•°æ¨ç§»ã‚°ãƒ©ãƒ•</h3>
            </div>
            <div class="card-body">
                <div id="monthlyCommentsChartResult" style="display: none;">
                    <canvas id="monthlyCommentsChart" width="1200" height="600"></canvas>
                </div>
                <div id="chartMessage" style="text-align: center; color: #666;"></div>
            </div>
        </div>
        
        <!-- æœˆåˆ¥å†ç”Ÿæ•°æ¨ç§»ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>æœˆåˆ¥å†ç”Ÿæ•°æ¨ç§»ã‚°ãƒ©ãƒ•</h3>
            </div>
            <div class="card-body">
                <div id="monthlyViewsChartResult" style="display: none;">
                    <canvas id="monthlyViewsChart" width="1200" height="600"></canvas>
                </div>
                <div id="viewsChartMessage" style="text-align: center; color: #666;"></div>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†</h3>
                <div>
                    <button class="btn btn-outline-primary" onclick="loadDatabaseVideos()">å‹•ç”»ä¸€è¦§</button>
                    <button class="btn btn-danger" onclick="clearAllData()">å…¨å‰Šé™¤</button>
                </div>
            </div>
            <div class="card-body">
                <div id="databaseResult" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«</th>
                                    <th>å†ç”Ÿæ•°</th>
                                    <th>åˆ†æã‚³ãƒ¡ãƒ³ãƒˆæ•°</th>
                                    <th>ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ•°</th>
                                    <th>åˆ†ææ—¥æ™‚</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="databaseTable"></tbody>
                        </table>
                    </div>
                </div>
                <div id="databaseMessage" style="text-align: center; color: #666; margin: 20px;"></div>
            </div>
        </div>
        
        <!-- å†ç”Ÿæ•°æ¨ç§»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>æœˆåˆ¥å†ç”Ÿæ•°æ¨ç§»</h3>
                <button class="btn btn-info" onclick="loadViewTrends()">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
            </div>
            <div class="card-body">
                <div id="viewTrendsResult" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«</th>
                                    <th>è¨˜éŒ²æ—¥æ™‚</th>
                                    <th>å†ç”Ÿæ•°</th>
                                    <th>ã„ã„ã­æ•°</th>
                                    <th>ã‚³ãƒ¡ãƒ³ãƒˆæ•°</th>
                                    <th>å‚™è€ƒ</th>
                                </tr>
                            </thead>
                            <tbody id="viewTrendsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let sentimentChart = null;
        let monthlyCommentsChart = null;
        let monthlyViewsChart = null;

        async function analyzeVideo() {
            const videoUrl = document.getElementById('videoUrl').value;
            if (!videoUrl) {
                alert('YouTubeå‹•ç”»URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            document.querySelector('.loading').style.display = 'block';
            document.getElementById('analysisResult').style.display = 'none';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ video_url: videoUrl })
                });

                const data = await response.json();
                
                if (response.ok) {
                    displayAnalysisResult(data);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                document.querySelector('.loading').style.display = 'none';
            }
        }

        function displayAnalysisResult(data) {
            const videoInfo = data.video_info;
            const sentiment = data.sentiment_summary;

            document.getElementById('videoInfo').innerHTML = `
                <div class="alert alert-info">
                    <h5>${videoInfo.title}</h5>
                    <p><strong>å†ç”Ÿæ•°:</strong> ${videoInfo.view_count.toLocaleString()}</p>
                    <p><strong>ã„ã„ã­æ•°:</strong> ${videoInfo.like_count.toLocaleString()}</p>
                    <p><strong>ã‚³ãƒ¡ãƒ³ãƒˆæ•°:</strong> ${videoInfo.comment_count.toLocaleString()}</p>
                    <p><strong>åˆ†ææ¸ˆã¿ã‚³ãƒ¡ãƒ³ãƒˆ:</strong> ${data.total_comments_analyzed}</p>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="sentiment-positive">${sentiment.positive}</h5>
                                <p>ãƒã‚¸ãƒ†ã‚£ãƒ–</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="sentiment-negative">${sentiment.negative}</h5>
                                <p>ãƒã‚¬ãƒ†ã‚£ãƒ–</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="sentiment-neutral">${sentiment.neutral}</h5>
                                <p>ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            createSentimentChart(sentiment);
            displayRepresentativeComments(data.representative_comments);
            document.getElementById('analysisResult').style.display = 'block';
        }
        
        function displayRepresentativeComments(comments) {
            const categories = ['positive', 'negative', 'neutral'];
            const containerIds = ['positiveComments', 'negativeComments', 'neutralComments'];
            
            categories.forEach((category, index) => {
                const container = document.getElementById(containerIds[index]);
                let html = '';
                
                if (comments[category] && comments[category].length > 0) {
                    comments[category].forEach(comment => {
                        html += `
                            <div class="border-bottom pb-2 mb-2">
                                <div class="fw-bold text-truncate">${comment.text}</div>
                                <small class="text-muted">ğŸ‘ ${comment.like_count} | ã‚¹ã‚³ã‚¢: ${comment.sentiment_score.toFixed(2)}</small>
                            </div>
                        `;
                    });
                } else {
                    html = '<p class="text-muted">ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                }
                
                container.innerHTML = html;
            });
        }

        function createSentimentChart(sentiment) {
            const ctx = document.getElementById('sentimentPieChart').getContext('2d');
            
            if (sentimentChart) {
                sentimentChart.destroy();
            }

            sentimentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['ãƒã‚¸ãƒ†ã‚£ãƒ–', 'ãƒã‚¬ãƒ†ã‚£ãƒ–', 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«'],
                    datasets: [{
                        data: [sentiment.positive, sentiment.negative, sentiment.neutral],
                        backgroundColor: ['#28a745', '#dc3545', '#6c757d']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ã‚³ãƒ¡ãƒ³ãƒˆæ„Ÿæƒ…åˆ†æ'
                        }
                    }
                }
            });
        }

        async function loadRankings() {
            try {
                const response = await fetch('/rankings');
                const data = await response.json();
                
                if (response.ok) {
                    displayRankings(data);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function displayRankings(data) {
            displayRankingList('negativeRanking', data.top_negative, 'negative_comments');
            displayRankingList('positiveRanking', data.top_positive, 'positive_comments');
            displayRankingList('commentsRanking', data.top_comments, 'total_comments');
            
            document.getElementById('rankingsResult').style.display = 'block';
        }

        function displayRankingList(elementId, rankingData, scoreField) {
            const element = document.getElementById(elementId);
            let html = '<ol class="list-group list-group-numbered">';
            
            rankingData.forEach(item => {
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">${item.title}</div>
                            <small>${item.month}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">${item[scoreField]}</span>
                    </li>
                `;
            });
            
            html += '</ol>';
            element.innerHTML = html;
        }

        async function loadViewTrends() {
            try {
                const response = await fetch('/view_trends');
                const data = await response.json();
                
                if (response.ok) {
                    displayViewTrends(data);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å†ç”Ÿæ•°æ¨ç§»å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function displayViewTrends(data) {
            const tableBody = document.getElementById('viewTrendsTable');
            let html = '';
            
            data.forEach(item => {
                const displayDate = item.snapshot_date || item.month;
                const note = item.note || '';
                
                html += `
                    <tr>
                        <td>${item.title}</td>
                        <td>${displayDate}</td>
                        <td>${item.view_count.toLocaleString()}</td>
                        <td>${item.like_count.toLocaleString()}</td>
                        <td>${item.comment_count.toLocaleString()}</td>
                        <td><small class="text-muted">${note}</small></td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            document.getElementById('viewTrendsResult').style.display = 'block';
        }
        
        async function loadMonthlyCommentsChart() {
            try {
                const response = await fetch('/monthly_comments_chart');
                const data = await response.json();
                
                if (response.ok) {
                    if (data.message) {
                        document.getElementById('chartMessage').innerText = data.message;
                        document.getElementById('monthlyCommentsChartResult').style.display = 'none';
                    } else {
                        displayMonthlyCommentsChart(data);
                        document.getElementById('chartMessage').innerText = '';
                    }
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('ã‚°ãƒ©ãƒ•å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        function displayMonthlyCommentsChart(data) {
            const ctx = document.getElementById('monthlyCommentsChart').getContext('2d');
            
            if (monthlyCommentsChart) {
                monthlyCommentsChart.destroy();
            }
            
            monthlyCommentsChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æœˆåˆ¥ã‚³ãƒ¡ãƒ³ãƒˆæ•°æ¨ç§»'
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ã‚³ãƒ¡ãƒ³ãƒˆæ•°'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æœˆ'
                            }
                        }
                    },
                    interaction: {
                        intersect: false
                    }
                }
            });
            
            document.getElementById('monthlyCommentsChartResult').style.display = 'block';
        }
        
        async function loadMonthlyViewsChart() {
            try {
                const response = await fetch('/monthly_views_chart');
                const data = await response.json();
                
                if (response.ok) {
                    if (data.message) {
                        document.getElementById('viewsChartMessage').innerText = data.message;
                        document.getElementById('monthlyViewsChartResult').style.display = 'none';
                    } else {
                        displayMonthlyViewsChart(data);
                        document.getElementById('viewsChartMessage').innerText = '';
                    }
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('ã‚°ãƒ©ãƒ•å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        function displayMonthlyViewsChart(data) {
            const ctx = document.getElementById('monthlyViewsChart').getContext('2d');
            
            if (monthlyViewsChart) {
                monthlyViewsChart.destroy();
            }
            
            monthlyViewsChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æœˆåˆ¥å†ç”Ÿæ•°æ¨ç§»'
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å†ç”Ÿæ•°'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value ? value.toLocaleString() : '';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æœˆ'
                            }
                        }
                    },
                    interaction: {
                        intersect: false
                    }
                }
            });
            
            document.getElementById('monthlyViewsChartResult').style.display = 'block';
        }
        
        async function analyzeCsvUrls() {
            if (!confirm('æ«»å‚46ã®1stã€œ12thã‚·ãƒ³ã‚°ãƒ«MVã‚’ä¸€æ‹¬åˆ†æã—ã¾ã™ã€‚æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            document.querySelector('.loading').style.display = 'block';
            
            try {
                const response = await fetch('/analyze_csv', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(data.message);
                    // æˆåŠŸã—ãŸå ´åˆã€ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                    loadMonthlyCommentsChart();
                    loadMonthlyViewsChart();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('ä¸€æ‹¬åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                document.querySelector('.loading').style.display = 'none';
            }
        }
        
        async function loadDatabaseVideos() {
            try {
                const response = await fetch('/database_management');
                const data = await response.json();
                
                if (response.ok) {
                    displayDatabaseVideos(data);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        function displayDatabaseVideos(videos) {
            const tableBody = document.getElementById('databaseTable');
            const messageDiv = document.getElementById('databaseMessage');
            
            if (videos.length === 0) {
                messageDiv.innerHTML = 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å‹•ç”»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
                document.getElementById('databaseResult').style.display = 'none';
                return;
            }
            
            messageDiv.innerHTML = '';
            let html = '';
            
            videos.forEach(video => {
                const createdDate = new Date(video.created_at).toLocaleString('ja-JP');
                html += `
                    <tr>
                        <td>
                            <div class="fw-bold">${video.title}</div>
                            <small class="text-muted">ID: ${video.id}</small>
                        </td>
                        <td>${video.view_count.toLocaleString()}</td>
                        <td>${video.total_comments_analyzed}</td>
                        <td>${video.snapshots_count}</td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteVideo('${video.id}', '${video.title}')">
                                å‰Šé™¤
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            document.getElementById('databaseResult').style.display = 'block';
        }
        
        async function deleteVideo(videoId, title) {
            if (!confirm(`ã€Œ${title}ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch('/delete_video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ video_id: videoId })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(data.message);
                    loadDatabaseVideos(); // ãƒªãƒ­ãƒ¼ãƒ‰
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        async function clearAllData() {
            if (!confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            if (!confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/clear_database', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(data.message);
                    loadDatabaseVideos(); // ãƒªãƒ­ãƒ¼ãƒ‰
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        window.addEventListener('load', function() {
            // æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’å–å¾—
            fetch('/last_updated')
                .then(response => response.json())
                .then(data => {
                    if (data.last_updated) {
                        document.getElementById('lastUpdated').innerHTML = 
                            `<span class="badge bg-success fs-6">æœ€çµ‚æ›´æ–°: ${data.last_updated}</span>`;
                    }
                })
                .catch(error => console.error('æœ€çµ‚æ›´æ–°æ—¥æ™‚å–å¾—ã‚¨ãƒ©ãƒ¼:', error));
            
            // å„ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å–å¾—
            loadRankings();
            loadMonthlyCommentsChart();
            loadMonthlyViewsChart();
        });
    </script>
</body>
</html>